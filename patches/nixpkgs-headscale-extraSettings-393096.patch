From 9b463668e01e754c52c7d3f396c81ce8dd54cb71 Mon Sep 17 00:00:00 2001
From: oliverwiegers <oliver.wiegers@netlogix.de>
Date: Tue, 25 Mar 2025 15:24:46 +0100
Subject: [PATCH] nixos/headscale: Add extraSettings option

`extraSettings` adds the possibility to headscale config options that
don't have a nixos module option exposed.
---
 .../modules/services/networking/headscale.nix | 139 +++++++++++++++---
 nixos/tests/headscale.nix                     |  22 +++
 2 files changed, 142 insertions(+), 19 deletions(-)

diff --git a/nixos/modules/services/networking/headscale.nix b/nixos/modules/services/networking/headscale.nix
index bd17f005f69b03..b40803c2370b07 100644
--- a/nixos/modules/services/networking/headscale.nix
+++ b/nixos/modules/services/networking/headscale.nix
@@ -18,8 +18,9 @@ let
     unix_socket = "${runDir}/headscale.sock";
   };

+  configOptions = lib.recursiveUpdate cfg.settings cfg.extraSettings;
   settingsFormat = pkgs.formats.yaml { };
-  configFile = settingsFormat.generate "headscale.yaml" cfg.settings;
+  configFile = settingsFormat.generate "headscale.yaml" configOptions;
   cliConfigFile = settingsFormat.generate "headscale.yaml" cliConfig;

   assertRemovedOption = option: message: {
@@ -487,74 +488,174 @@ in
           };
         };
       };
+
+      extraSettings = lib.mkOption {
+        default = { };
+        type = lib.types.attrsOf lib.types.anything;
+        description = ''
+          Extra configuration options which are serialized to yaml and added
+          to the headscale.yaml file.
+        '';
+      };
     };
   };

   imports = with lib; [
     (mkRenamedOptionModule
       [ "services" "headscale" "derp" "autoUpdate" ]
-      [ "services" "headscale" "settings" "derp" "auto_update_enable" ]
+      [
+        "services"
+        "headscale"
+        "settings"
+        "derp"
+        "auto_update_enable"
+      ]
     )
     (mkRenamedOptionModule
       [ "services" "headscale" "derp" "paths" ]
-      [ "services" "headscale" "settings" "derp" "paths" ]
+      [
+        "services"
+        "headscale"
+        "settings"
+        "derp"
+        "paths"
+      ]
     )
     (mkRenamedOptionModule
       [ "services" "headscale" "derp" "updateFrequency" ]
-      [ "services" "headscale" "settings" "derp" "update_frequency" ]
+      [
+        "services"
+        "headscale"
+        "settings"
+        "derp"
+        "update_frequency"
+      ]
     )
     (mkRenamedOptionModule
       [ "services" "headscale" "derp" "urls" ]
-      [ "services" "headscale" "settings" "derp" "urls" ]
+      [
+        "services"
+        "headscale"
+        "settings"
+        "derp"
+        "urls"
+      ]
     )
     (mkRenamedOptionModule
-      [ "services" "headscale" "ephemeralNodeInactivityTimeout" ]
+      [
+        "services"
+        "headscale"
+        "ephemeralNodeInactivityTimeout"
+      ]
       [ "services" "headscale" "settings" "ephemeral_node_inactivity_timeout" ]
     )
     (mkRenamedOptionModule
       [ "services" "headscale" "logLevel" ]
-      [ "services" "headscale" "settings" "log" "level" ]
+      [
+        "services"
+        "headscale"
+        "settings"
+        "log"
+        "level"
+      ]
     )
     (mkRenamedOptionModule
-      [ "services" "headscale" "openIdConnect" "clientId" ]
+      [
+        "services"
+        "headscale"
+        "openIdConnect"
+        "clientId"
+      ]
       [ "services" "headscale" "settings" "oidc" "client_id" ]
     )
     (mkRenamedOptionModule
-      [ "services" "headscale" "openIdConnect" "clientSecretFile" ]
+      [
+        "services"
+        "headscale"
+        "openIdConnect"
+        "clientSecretFile"
+      ]
       [ "services" "headscale" "settings" "oidc" "client_secret_path" ]
     )
     (mkRenamedOptionModule
       [ "services" "headscale" "openIdConnect" "issuer" ]
-      [ "services" "headscale" "settings" "oidc" "issuer" ]
+      [
+        "services"
+        "headscale"
+        "settings"
+        "oidc"
+        "issuer"
+      ]
     )
     (mkRenamedOptionModule
       [ "services" "headscale" "serverUrl" ]
-      [ "services" "headscale" "settings" "server_url" ]
+      [
+        "services"
+        "headscale"
+        "settings"
+        "server_url"
+      ]
     )
     (mkRenamedOptionModule
       [ "services" "headscale" "tls" "certFile" ]
-      [ "services" "headscale" "settings" "tls_cert_path" ]
+      [
+        "services"
+        "headscale"
+        "settings"
+        "tls_cert_path"
+      ]
     )
     (mkRenamedOptionModule
       [ "services" "headscale" "tls" "keyFile" ]
-      [ "services" "headscale" "settings" "tls_key_path" ]
+      [
+        "services"
+        "headscale"
+        "settings"
+        "tls_key_path"
+      ]
     )
     (mkRenamedOptionModule
-      [ "services" "headscale" "tls" "letsencrypt" "challengeType" ]
+      [
+        "services"
+        "headscale"
+        "tls"
+        "letsencrypt"
+        "challengeType"
+      ]
       [ "services" "headscale" "settings" "tls_letsencrypt_challenge_type" ]
     )
     (mkRenamedOptionModule
-      [ "services" "headscale" "tls" "letsencrypt" "hostname" ]
+      [
+        "services"
+        "headscale"
+        "tls"
+        "letsencrypt"
+        "hostname"
+      ]
       [ "services" "headscale" "settings" "tls_letsencrypt_hostname" ]
     )
     (mkRenamedOptionModule
-      [ "services" "headscale" "tls" "letsencrypt" "httpListen" ]
+      [
+        "services"
+        "headscale"
+        "tls"
+        "letsencrypt"
+        "httpListen"
+      ]
       [ "services" "headscale" "settings" "tls_letsencrypt_listen" ]
     )

-    (mkRemovedOptionModule [ "services" "headscale" "openIdConnect" "domainMap" ] ''
-      Headscale no longer uses domain_map. If you're using an old version of headscale you can still set this option via services.headscale.settings.oidc.domain_map.
-    '')
+    (mkRemovedOptionModule
+      [
+        "services"
+        "headscale"
+        "openIdConnect"
+        "domainMap"
+      ]
+      ''
+        Headscale no longer uses domain_map. If you're using an old version of headscale you can still set this option via services.headscale.settings.oidc.domain_map.
+      ''
+    )
   ];

   config = lib.mkIf cfg.enable {
diff --git a/nixos/tests/headscale.nix b/nixos/tests/headscale.nix
index 3ba331b7c3d4b4..a4721d29119f38 100644
--- a/nixos/tests/headscale.nix
+++ b/nixos/tests/headscale.nix
@@ -46,6 +46,15 @@ import ./make-test-python.nix (
                 };
                 dns.base_domain = "tailnet";
               };
+              extraSettings = {
+                dns.extra_records = [
+                  {
+                    name = "grafana.myvpn.example.com";
+                    type = "A";
+                    value = "100.64.0.3";
+                  }
+                ];
+              };
             };
             nginx = {
               enable = true;
@@ -71,8 +80,16 @@ import ./make-test-python.nix (
         };
       };

+    # Type checking on extra packages doesn't work yet
+    skipTypeCheck = true;
+
+    extraPythonPackages = p: [ p.pyyaml ];
+
     testScript = ''
+      import yaml
+
       start_all()
+
       headscale.wait_for_unit("headscale")
       headscale.wait_for_open_port(443)

@@ -88,6 +105,11 @@ import ./make-test-python.nix (
       # Check that they are reachable from the tailnet
       peer1.wait_until_succeeds("tailscale ping peer2")
       peer2.wait_until_succeeds("tailscale ping peer1.tailnet")
+
+      with open("/etc/headscale/config.yaml", encoding="utf-8") as config:
+          config_dict = yaml.safe_load(config)
+          assert "extra_records" in config_dict["dns"].keys(), "Config file does not contain settings from services.headscale.extraSettings."
+          assert config_dict["dns"]["extra_records"][0]["name"] == "grafana.myvpn.example.com", "Extra record has wrong name or does not exist."
     '';
   }
 )
